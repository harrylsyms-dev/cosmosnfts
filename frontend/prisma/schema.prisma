// Prisma schema for CosmoNFT - Celestial NFT Marketplace

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

// Badge Tier - 6 tiers based on score rank
enum BadgeTier {
  MYTHIC      // Top 20 (0.10%) - 200x multiplier
  LEGENDARY   // Next 100 (0.50%) - 100x multiplier
  ELITE       // Next 400 (2.00%) - 50x multiplier
  PREMIUM     // Next 1,000 (5.00%) - 20x multiplier
  EXCEPTIONAL // Next 2,000 (10.00%) - 5x multiplier
  STANDARD    // Remaining 16,480 (82.40%) - 1x multiplier
}

// Object Category - 19 categories (removed OTHER and COSMIC_FEATURE)
enum ObjectCategory {
  STAR
  GALAXY
  NEBULA
  EXOPLANET
  STAR_CLUSTER
  ASTEROID
  MOON
  COMET
  PULSAR
  BLACK_HOLE
  QUASAR
  SUPERNOVA_REMNANT
  WHITE_DWARF
  NEUTRON_STAR
  BROWN_DWARF
  DWARF_PLANET
  PLANET
  MAGNETAR
  SPACECRAFT
}

// NFT Status
enum NFTStatus {
  UNASSIGNED      // Not yet assigned to series/phase
  AVAILABLE       // Ready for purchase
  RESERVED        // In someone's cart
  AUCTION_ACTIVE  // Currently being auctioned
  SOLD            // Purchased
  MINTED          // Minted to blockchain
}

// NFT Model - Celestial objects (20,000 total hard cap)
model NFT {
  id                      Int            @id @default(autoincrement())
  tokenId                 Int            @unique @map("token_id")
  name                    String
  description             String?

  // ============================================
  // CATEGORY
  // ============================================
  objectType              String?        @map("object_type")      // Legacy string field
  objectCategory          ObjectCategory @default(STAR)           // Proper category (no OTHER)

  // ============================================
  // NEW 10-METRIC SCORING SYSTEM (max 300 total)
  // ============================================
  culturalSignificance    Int            @default(0) @map("cultural_significance")    // 0-60: Public recognition, "household name"
  scientificImportance    Int            @default(0) @map("scientific_importance")    // 0-50: Research papers, discoveries
  historicalSignificance  Int            @default(0) @map("historical_significance")  // 0-40: Discovery importance, firsts
  visualImpact            Int            @default(0) @map("visual_impact")            // 0-30: How spectacular it looks
  uniqueness              Int            @default(0) @map("uniqueness_score")         // 0-30: One of a kind, rare type
  accessibility           Int            @default(0) @map("accessibility_score")      // 0-20: Can we see/visit/study it
  proximity               Int            @default(0) @map("proximity_score")          // 0-20: Distance relevance
  storyFactor             Int            @default(0) @map("story_factor")             // 0-20: Mythology, cultural stories
  activeRelevance         Int            @default(0) @map("active_relevance")         // 0-15: Current missions, in the news
  futurePotential         Int            @default(0) @map("future_potential")         // 0-15: Upcoming missions, habitability

  totalScore              Int            @default(0) @map("total_score")              // Sum of above (0-300)

  // Legacy scoring fields (kept for migration, will be deprecated)
  fameVisibility          Int            @default(0) @map("fame_visibility")
  rarity                  Int            @default(0)
  discoveryRecency        Int            @default(0) @map("discovery_recency")
  cosmicScore             Int            @default(0) @map("cosmic_score")

  // ============================================
  // TIER SYSTEM
  // ============================================
  badgeTier               BadgeTier      @default(STANDARD) @map("badge_tier_enum")
  badgeTierLegacy         String?        @map("badge_tier")        // Legacy string field
  tierMultiplier          Int            @default(1) @map("tier_multiplier")          // 200, 100, 50, 20, 5, 1
  tierRank                Int?           @map("tier_rank")                            // Rank within tier (e.g., #5 of 20 MYTHIC)

  // ============================================
  // SERIES & PHASE ASSIGNMENT
  // ============================================
  seriesId                String?        @map("series_id")
  series                  Series?        @relation("SeriesNFTs", fields: [seriesId], references: [id])
  seriesNumber            Int?           @map("series_number")                        // 1, 2, 3, or 4

  phaseId                 String?        @map("phase_id")
  phase                   Phase?         @relation("PhaseNFTs", fields: [phaseId], references: [id])
  phaseNumber             Int?           @map("phase_number")                         // 1-5 within series

  // Auction assignment (for MYTHIC items)
  auctionPhase            Phase?         @relation("PhaseAuction")
  isAuctionItem           Boolean        @default(false) @map("is_auction_item")

  // ============================================
  // PRICING
  // ============================================
  currentPriceCents       BigInt?        @map("current_price_cents")                  // Calculated: $0.10 × score × tierMult × seriesMult
  basePriceCents          Int            @default(0) @map("base_price_cents")         // Legacy
  currentPrice            Float          @default(0) @map("current_price")            // Legacy

  // ============================================
  // STATUS
  // ============================================
  status                  String         @default("AVAILABLE")                        // Legacy string status
  nftStatus               NFTStatus      @default(UNASSIGNED) @map("nft_status_enum") // New enum status

  // ============================================
  // CURATION
  // ============================================
  isCurated               Boolean        @default(false) @map("is_curated")           // Hand-scored (~200 objects)
  curatedAt               DateTime?      @map("curated_at")
  curatedBy               String?        @map("curated_by")                           // Admin who curated

  // ============================================
  // SCIENTIFIC DATA (from catalogs like HYG, SIMBAD)
  // ============================================
  spectralType            String?        @map("spectral_type")
  distanceLy              Float?         @map("distance_ly")
  massSolar               Float?         @map("mass_solar")
  temperatureK            Float?         @map("temperature_k")
  luminosity              Float?         @map("luminosity_value")
  apparentMagnitude       Float?         @map("apparent_magnitude")
  absoluteMagnitude       Float?         @map("absolute_magnitude")
  discoveryYear           Int?           @map("discovery_year")
  constellation           String?
  distance                String?
  notableFeatures         String?        @map("notable_features")
  visualFeatures          String?        @map("visual_features")

  // ============================================
  // EXTERNAL API DATA (for scoring)
  // ============================================
  // Wikipedia API data
  wikipediaPageViews      Int?           @map("wikipedia_page_views")
  wikipediaArticleLength  Int?           @map("wikipedia_article_length")

  // NASA ADS API data
  totalPaperCount         Int?           @map("total_paper_count")
  recentPaperCount        Int?           @map("recent_paper_count")

  // Wikidata API data
  wikidataSitelinks       Int?           @map("wikidata_sitelinks")
  wikidataCulturalRefs    Int?           @map("wikidata_cultural_refs")
  wikidataId              String?        @map("wikidata_id")

  // Data collection tracking
  dataCollectedAt         DateTime?      @map("data_collected_at")
  dataCompleteness        Int?           @map("data_completeness")   // 0-100%
  lowConfidence           Boolean        @default(false) @map("low_confidence")

  // Additional scoring-relevant flags
  hasImages               Boolean        @default(false) @map("has_images")
  namedByAncients         Boolean        @default(false) @map("named_by_ancients")
  hasActiveMission        Boolean        @default(false) @map("has_active_mission")
  plannedMission          Boolean        @default(false) @map("planned_mission")
  isHabitable             Boolean        @default(false) @map("is_habitable")
  isInSolarSystem         Boolean        @default(false) @map("is_in_solar_system")

  // ============================================
  // IMAGE GENERATION
  // ============================================
  image                   String?
  imageIpfsHash           String?        @map("image_ipfs_hash")
  metadataIpfsHash        String?        @map("metadata_ipfs_hash")
  imagePrompt             String?        @map("image_prompt") @db.Text
  imageNegativePrompt     String?        @map("image_negative_prompt") @db.Text
  promptGeneratedAt       DateTime?      @map("prompt_generated_at")
  referenceImageUrl       String?        @map("reference_image_url")
  referenceImageSource    String?        @map("reference_image_source")
  leonardoRefImageId      String?        @map("leonardo_ref_image_id")

  // ============================================
  // BLOCKCHAIN / OWNERSHIP
  // ============================================
  transactionHash         String?        @map("transaction_hash")
  ownerAddress            String?        @map("owner_address")
  currentTier             Int            @default(1) @map("current_tier")             // Legacy pricing tier

  // ============================================
  // TIMESTAMPS
  // ============================================
  createdAt               DateTime       @default(now()) @map("created_at")
  updatedAt               DateTime       @updatedAt @map("updated_at")
  mintedAt                DateTime?      @map("minted_at")
  soldAt                  DateTime?      @map("sold_at")

  // ============================================
  // RELATIONS
  // ============================================
  cartItems               CartItem[]
  auctions                Auction[]
  listings                Listing[]
  trades                  Trade[]
  scheduledAuction        ScheduledAuction?

  @@index([status])
  @@index([nftStatus])
  @@index([totalScore])
  @@index([badgeTier])
  @@index([objectCategory])
  @@index([seriesId])
  @@index([phaseId])
  @@index([isCurated])
  @@map("nfts")
}

// Shopping Cart
model Cart {
  id        String     @id @default(uuid())
  userId    String     @map("user_id")
  expiresAt DateTime   @map("expires_at")
  createdAt DateTime   @default(now()) @map("created_at")

  items     CartItem[]

  @@index([userId])
  @@index([expiresAt])
  @@map("carts")
}

// Cart Items
model CartItem {
  id         Int      @id @default(autoincrement())
  cartId     String   @map("cart_id")
  nftId      Int      @map("nft_id")
  priceAtAdd Float    @map("price_at_add")
  addedAt    DateTime @default(now()) @map("added_at")

  cart       Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  nft        NFT      @relation(fields: [nftId], references: [id])

  @@unique([cartId, nftId])
  @@map("cart_items")
}

// Purchase Records
model Purchase {
  id                  String    @id @default(uuid())
  email               String
  walletAddress       String?   @map("wallet_address")
  totalAmountCents    Int       @map("total_amount_cents")

  // Status: PENDING, PROCESSING, MINTED, FAILED, MINT_FAILED, DISPUTED, REFUNDED
  status              String    @default("PENDING")

  // Stripe data
  stripeTransactionId String?   @map("stripe_transaction_id")

  // Blockchain data
  transactionHash     String?   @map("transaction_hash")

  // NFT IDs (stored as JSON string for SQLite compatibility)
  nftIds              String    @map("nft_ids")

  // Error handling
  failureReason       String?   @map("failure_reason")

  // Timestamps
  createdAt           DateTime  @default(now()) @map("created_at")
  mintedAt            DateTime? @map("minted_at")

  @@index([email])
  @@index([status])
  @@index([stripeTransactionId])
  @@map("purchases")
}

// Pricing Tiers (DEPRECATED - kept for migration reference)
model Tier {
  id                Int      @id @default(autoincrement())
  phase             Int      @unique
  price             Float    // Base price in USD
  quantityAvailable Int      @map("quantity_available")
  quantitySold      Int      @default(0) @map("quantity_sold")
  startTime         DateTime @map("start_time")
  duration          Int      // Duration in seconds
  active            Boolean  @default(false)

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("tiers")
}

// ============================================
// NEW SERIES & PHASE SYSTEM
// ============================================

// Series - 4 series of 5,000 NFTs each (20,000 total)
model Series {
  id                  String        @id @default(cuid())
  seriesNumber        Int           @unique @map("series_number") // 1, 2, 3, 4
  multiplier          Decimal       @default(1.0) @db.Decimal(10, 2) // 1.0, 1.5, 2.0, 2.5, 3.0+
  status              SeriesStatus  @default(PLANNED)

  // Inventory
  totalNFTs           Int           @default(5000) @map("total_nfts")
  soldCount           Int           @default(0) @map("sold_count")

  // Calculated sell-through rate (0.00 to 1.00)
  sellThroughRate     Decimal?      @map("sell_through_rate") @db.Decimal(5, 4)

  // Timing
  startDate           DateTime?     @map("start_date")
  endDate             DateTime?     @map("end_date")

  // Revenue tracking (in cents)
  totalRevenueCents   BigInt        @default(0) @map("total_revenue_cents")
  donationAmountCents BigInt        @default(0) @map("donation_amount_cents") // 30% of revenue

  // Relations
  phases              Phase[]
  nfts                NFT[]         @relation("SeriesNFTs")

  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  @@map("series")
}

enum SeriesStatus {
  PLANNED     // Not yet started
  ACTIVE      // Currently selling
  COMPLETED   // All phases done
  PAUSED      // Temporarily stopped
}

// Phase - 5 phases per series, 1,000 NFTs each
model Phase {
  id                  String        @id @default(cuid())
  seriesId            String        @map("series_id")
  series              Series        @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  phaseNumber         Int           @map("phase_number") // 1-5 within series
  status              PhaseStatus   @default(PENDING)

  // Inventory
  totalNFTs           Int           @default(1000) @map("total_nfts")
  soldCount           Int           @default(0) @map("sold_count")

  // Timing (in days)
  durationDays        Int           @default(14) @map("duration_days")
  startDate           DateTime?     @map("start_date")
  endDate             DateTime?     @map("end_date") // Calculated: startDate + durationDays

  // Pause handling
  isPaused            Boolean       @default(false) @map("is_paused")
  pausedAt            DateTime?     @map("paused_at")
  totalPausedMs       BigInt        @default(0) @map("total_paused_ms")

  // Auction - one NFT per phase selected for auction
  auctionNFTId        Int?          @unique @map("auction_nft_id")
  auctionNFT          NFT?          @relation("PhaseAuction", fields: [auctionNFTId], references: [id])

  // Relations
  nfts                NFT[]         @relation("PhaseNFTs")

  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  @@unique([seriesId, phaseNumber])
  @@index([status])
  @@map("phases")
}

enum PhaseStatus {
  PENDING     // Not yet started
  ACTIVE      // Currently open
  COMPLETED   // Closed
  PAUSED      // Temporarily stopped
}

// Chargeback Evidence
model ChargebackEvidence {
  id           Int      @id @default(autoincrement())
  disputeId    String   @unique @map("dispute_id")
  purchaseId   String   @map("purchase_id")
  evidenceJson String   @map("evidence_json")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("chargeback_evidence")
}

// Payment Failures (for monitoring)
model PaymentFailure {
  id                  Int      @id @default(autoincrement())
  email               String
  stripeTransactionId String?  @map("stripe_transaction_id")
  errorMessage        String   @map("error_message")
  createdAt           DateTime @default(now()) @map("created_at")

  @@index([email])
  @@map("payment_failures")
}

// Auctions (High-profile objects - 20% of inventory)
model Auction {
  id                    String      @id @default(uuid())
  tokenId               Int         @map("token_id")
  nftName               String      @map("nft_name")
  startingBidCents      Int         @map("starting_bid_cents")
  currentBidCents       Int         @map("current_bid_cents")
  highestBidderAddress  String?     @map("highest_bidder_address")

  // Status: PENDING, ACTIVE, ENDED, FINALIZED
  status                String      @default("PENDING")

  startTime             DateTime    @map("start_time")
  endTime               DateTime    @map("end_time")
  createdAt             DateTime    @default(now()) @map("created_at")

  // Relations
  nft                   NFT         @relation(fields: [tokenId], references: [tokenId])
  bids                  AuctionBid[]

  @@index([status])
  @@index([endTime])
  @@map("auctions")
}

// Auction Bids (Bid history)
model AuctionBid {
  id                String    @id @default(uuid())
  auctionId         String    @map("auction_id")
  bidderAddress     String    @map("bidder_address")
  bidderEmail       String?   @map("bidder_email")
  bidAmountCents    Int       @map("bid_amount_cents")
  timestamp         DateTime  @default(now())
  paymentIntentId   String?   @map("payment_intent_id")

  // Status: PENDING, CONFIRMED, REFUNDED
  status            String    @default("PENDING")

  // Relations
  auction           Auction   @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@index([auctionId])
  @@index([bidderAddress])
  @@map("auction_bids")
}

// Auction History (Past auctions)
model AuctionHistory {
  id                String    @id @default(uuid())
  tokenId           Int       @map("token_id")
  nftName           String    @map("nft_name")
  finalPriceCents   Int       @map("final_price_cents")
  winnerAddress     String    @map("winner_address")
  winnerEmail       String?   @map("winner_email")
  auctionDate       DateTime  @map("auction_date")
  blockchainHash    String?   @map("blockchain_hash")
  createdAt         DateTime  @default(now()) @map("created_at")

  @@index([tokenId])
  @@map("auction_history")
}

// Royalty Splits (Track revenue distribution)
model RoyaltySplit {
  id                        Int       @id @default(autoincrement())
  transactionId             String    @map("transaction_id")

  // Type: PURCHASE, SECONDARY_SALE, AUCTION
  transactionType           String    @map("transaction_type")

  totalAmountCents          Int       @map("total_amount_cents")
  creatorShareCents         Int       @map("creator_share_cents")
  benefactorShareCents      Int       @map("benefactor_share_cents")
  paidAt                    DateTime? @map("paid_at")
  createdAt                 DateTime  @default(now()) @map("created_at")

  @@index([transactionId])
  @@map("royalty_splits")
}

// Email Logs
model EmailLog {
  id          String    @id @default(uuid())
  recipient   String

  // Type: PURCHASE_RECEIPT, MINTED_NOTIFICATION, PAYMENT_FAILED, AUCTION_OUTBID, AUCTION_WON
  emailType   String    @map("email_type")

  // Status: SENT, FAILED, BOUNCED
  status      String    @default("SENT")

  sentAt      DateTime  @default(now()) @map("sent_at")

  @@index([recipient])
  @@map("email_logs")
}

// Admin Users
model AdminUser {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String?
  role          String    @default("ADMIN") // ADMIN, SUPER_ADMIN
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  privileges    String?   @default("[]") // JSON: section access privileges

  sessions      AdminSession[]
  dashboardPreference AdminDashboardPreference?

  @@map("admin_users")
}

// Admin Dashboard Preferences
model AdminDashboardPreference {
  id              String    @id @default(uuid())
  adminId         String    @unique @map("admin_id")
  layout          String    @default("[]") @map("layout") // JSON: widget configs
  starredWidgets  String    @default("[]") @map("starred_widgets") // JSON: starred widget IDs
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  admin           AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_dashboard_preferences")
}

// Admin Sessions
model AdminSession {
  id          String    @id @default(uuid())
  adminId     String    @map("admin_id")
  token       String    @unique
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")

  admin       AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([adminId])
  @@map("admin_sessions")
}

// Site Settings (for maintenance mode, coming soon, etc.)
model SiteSettings {
  id              String    @id @default("main")
  isLive          Boolean   @default(false) @map("is_live")
  maintenanceMode Boolean   @default(false) @map("maintenance_mode")
  comingSoonMode  Boolean   @default(true) @map("coming_soon_mode")
  launchDate      DateTime? @map("launch_date")
  comingSoonTitle String?   @map("coming_soon_title")
  comingSoonMessage String? @map("coming_soon_message")
  previewPassword String?   @map("preview_password")

  // HTML Content for Coming Soon and Maintenance pages
  comingSoonHtml      String?   @map("coming_soon_html")
  comingSoonPassword  String?   @map("coming_soon_password")
  maintenanceHtml     String?   @map("maintenance_html")

  // Leonardo AI global prompt
  leonardoPrompt      String?   @map("leonardo_prompt")

  // ============================================
  // CURRENT SERIES/PHASE STATE
  // ============================================
  currentSeriesId     String?   @map("current_series_id")
  currentPhaseId      String?   @map("current_phase_id")

  // Phase timer controls (legacy)
  phasePaused       Boolean   @default(false) @map("phase_paused")
  pausedAt          DateTime? @map("paused_at")
  pauseDurationMs   Int       @default(0) @map("pause_duration_ms")
  contractPaused    Boolean   @default(false) @map("contract_paused")

  // Phase pricing configuration (legacy)
  phaseIncreasePercent  Float     @default(7.5) @map("phase_increase_percent")

  // ============================================
  // TIER MULTIPLIERS
  // ============================================
  mythicMultiplier      Int       @default(200) @map("mythic_multiplier")
  legendaryMultiplier   Int       @default(100) @map("legendary_multiplier")
  eliteMultiplier       Int       @default(50) @map("elite_multiplier")
  premiumMultiplier     Int       @default(20) @map("premium_multiplier")
  exceptionalMultiplier Int       @default(5) @map("exceptional_multiplier")
  standardMultiplier    Int       @default(1) @map("standard_multiplier")

  // ============================================
  // PRICING CONFIGURATION
  // ============================================
  maxPossibleScore      Int       @default(300) @map("max_possible_score")
  basePricePerScore     Decimal   @default(0.10) @map("base_price_per_score") @db.Decimal(10, 4)

  // ============================================
  // TIER DISTRIBUTION TARGETS
  // ============================================
  mythicCount           Int       @default(20) @map("mythic_count")
  legendaryCount        Int       @default(100) @map("legendary_count")
  eliteCount            Int       @default(400) @map("elite_count")
  premiumCount          Int       @default(1000) @map("premium_count")
  exceptionalCount      Int       @default(2000) @map("exceptional_count")
  standardCount         Int       @default(16480) @map("standard_count")

  // Sandbox/Testing Mode
  sandboxMode           Boolean   @default(false) @map("sandbox_mode")
  paymentsEnabled       Boolean   @default(true) @map("payments_enabled")

  // Wallet & Revenue Configuration
  ownerWalletAddress      String?   @map("owner_wallet_address")
  benefactorWalletAddress String?   @map("benefactor_wallet_address")
  benefactorName          String?   @default("Space Exploration Fund") @map("benefactor_name")
  ownerSharePercent       Int       @default(70) @map("owner_share_percent")
  benefactorSharePercent  Int       @default(30) @map("benefactor_share_percent")

  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("site_settings")
}

// Comprehensive Image Prompt Configuration
model ImagePromptConfig {
  id                    String    @id @default("main")

  // === BASE PROMPT TEMPLATE ===
  basePromptTemplate    String?   @map("base_prompt_template") @db.Text

  // === STYLE PARAMETERS ===
  artStyle              String    @default("photorealistic astrophotography") @map("art_style")
  colorPalette          String    @default("Natural space colors, deep blacks, subtle nebula hues") @map("color_palette")
  lightingStyle         String    @default("Natural starlight, subtle glow effects") @map("lighting_style")
  compositionStyle      String    @default("Scientific, documentary-style") @map("composition_style")
  qualityDescriptors    String    @default("8K, ultra high definition, NASA-quality") @map("quality_descriptors")
  mediumDescriptors     String    @default("Telescope photography, Hubble-style imagery") @map("medium_descriptors")

  // === REALISM CONTROLS ===
  realismLevel          Int       @default(80) @map("realism_level")
  usePhotorealistic     Boolean   @default(true) @map("use_photorealistic")
  useScientificAccuracy Boolean   @default(true) @map("use_scientific_accuracy")
  avoidArtisticStylization Boolean @default(true) @map("avoid_artistic_stylization")

  // === LEONARDO AI PARAMETERS ===
  leonardoModelId       String    @default("flux-pro-2.0") @map("leonardo_model_id") // FLUX.2 Pro (V2 API)
  leonardoModelName     String    @default("FLUX.2 Pro") @map("leonardo_model_name") // Display name
  imageWidth            Int       @default(1440) @map("image_width")
  imageHeight           Int       @default(1440) @map("image_height")
  contrast              Float     @default(3.5) @map("contrast") // FLUX: 1.0, 1.3, 1.8, 2.5, 3, 3.5, 4, 4.5
  enhancePrompt         Boolean   @default(false) @map("enhance_prompt") // MUST be false for scientific accuracy
  presetStyle           String?   @map("preset_style") // CINEMATIC, DYNAMIC, CREATIVE, etc. (SDXL models)
  isPublic              Boolean   @default(false) @map("is_public") // Privacy mode - false = private generations
  promptMagic           Boolean   @default(false) @map("prompt_magic") // Legacy, keep false
  guidanceScale         Float     @default(7) @map("guidance_scale") // For non-FLUX models
  numImages             Int       @default(1) @map("num_images")

  // === NEGATIVE PROMPT ===
  negativePrompt        String    @default("cartoon, anime, illustration, painting, artistic, stylized, fantasy, magical, glowing effects, text, watermarks, signatures, logos, words, letters, blur, low quality") @map("negative_prompt") @db.Text

  // === OBJECT TYPE CONFIGURATIONS (JSON) ===
  objectTypeConfigs     String    @default("{}") @map("object_type_configs") @db.Text

  // === SCORE-BASED MODIFIERS ===
  premiumThreshold      Int       @default(400) @map("premium_threshold")
  eliteThreshold        Int       @default(425) @map("elite_threshold")
  legendaryThreshold    Int       @default(450) @map("legendary_threshold")
  premiumModifier       String    @default("Exceptional detail and clarity") @map("premium_modifier")
  eliteModifier         String    @default("Museum-quality, breathtaking composition") @map("elite_modifier")
  legendaryModifier     String    @default("Once-in-a-lifetime capture, iconic imagery") @map("legendary_modifier")

  // === ADVANCED OPTIONS ===
  includeScoreInPrompt  Boolean   @default(false) @map("include_score_in_prompt")
  includeMetadataInPrompt Boolean @default(true) @map("include_metadata_in_prompt")
  useDescriptionTransform Boolean @default(false) @map("use_description_transform")
  useNftDescription     Boolean   @default(true) @map("use_nft_description")

  // === TEMPLATE SYSTEM ===
  useAstronomicalTemplates Boolean @default(true) @map("use_astronomical_templates") // Use new astronomical prompt templates (tested for Leonardo AI)

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@map("image_prompt_config")
}

// Encrypted API Keys Storage
model ApiKey {
  id            String    @id @default(uuid())
  service       String    @unique  // e.g., "stripe", "pinata", "leonardo", "polygon_rpc"
  encryptedKey  String    @map("encrypted_key")  // AES-256-GCM encrypted
  description   String?   // Human-readable description
  lastRotated   DateTime? @map("last_rotated")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  createdBy     String?   @map("created_by")  // Admin ID who created/updated

  @@map("api_keys")
}


// User (Wallet-based authentication)
model User {
  id            String    @id @default(uuid())
  walletAddress String    @unique @map("wallet_address")
  nonce         String    // Random nonce for signature verification
  email         String?   // Optional email for notifications
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  sessions      UserSession[]

  @@map("users")
}

// User Sessions
model UserSession {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("user_sessions")
}

// Auction Schedule Overrides (for custom pricing)
model AuctionScheduleOverride {
  id                String   @id @default(uuid())
  name              String   @unique  // Name of the celestial object
  startingBidCents  Int      @map("starting_bid_cents")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("auction_schedule_overrides")
}

// Scheduled auctions - admin-selected NFTs for future auctions
model ScheduledAuction {
  id                String    @id @default(uuid())
  nftId             Int       @unique @map("nft_id")
  nft               NFT       @relation(fields: [nftId], references: [id], onDelete: Cascade)
  week              Int       // Week number when auction should start
  startingBidCents  Int       @map("starting_bid_cents")
  priority          Int       @default(0) // Higher priority = featured more prominently
  status            String    @default("SCHEDULED") // SCHEDULED, ACTIVE, COMPLETED, CANCELLED
  auctionId         String?   @map("auction_id") // Links to actual Auction once started
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("scheduled_auctions")
}

// ============================================
// MARKETPLACE MODELS
// ============================================

// Marketplace Listings (Fixed Price Sales)
model Listing {
  id              String    @id @default(uuid())
  tokenId         Int       @unique @map("token_id")
  sellerAddress   String    @map("seller_address")
  sellerEmail     String?   @map("seller_email")
  priceCents      Int       @map("price_cents")

  // Status: ACTIVE, SOLD, CANCELLED, EXPIRED
  status          String    @default("ACTIVE")

  // Smart contract data
  escrowTxHash    String?   @map("escrow_tx_hash")

  createdAt       DateTime  @default(now()) @map("created_at")
  expiresAt       DateTime? @map("expires_at")
  soldAt          DateTime? @map("sold_at")
  cancelledAt     DateTime? @map("cancelled_at")

  // Relations
  nft             NFT       @relation(fields: [tokenId], references: [tokenId])
  offers          Offer[]

  @@index([status])
  @@index([sellerAddress])
  @@index([tokenId])
  @@map("listings")
}

// Offers on NFTs
model Offer {
  id                String    @id @default(uuid())
  listingId         String?   @map("listing_id")
  tokenId           Int       @map("token_id")
  offererAddress    String    @map("offerer_address")
  offererEmail      String?   @map("offerer_email")
  offerAmountCents  Int       @map("offer_amount_cents")

  // Status: PENDING, ACCEPTED, COUNTERED, REJECTED, EXPIRED, CANCELLED
  status            String    @default("PENDING")

  // Counter offer tracking
  counterOfferCents Int?      @map("counter_offer_cents")
  parentOfferId     String?   @map("parent_offer_id")

  expiresAt         DateTime  @map("expires_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  respondedAt       DateTime? @map("responded_at")

  // Relations
  listing           Listing?  @relation(fields: [listingId], references: [id])

  @@index([tokenId])
  @@index([offererAddress])
  @@index([status])
  @@index([listingId])
  @@map("offers")
}

// Trade History (All Secondary Sales)
model Trade {
  id                   String   @id @default(uuid())
  tokenId              Int      @map("token_id")

  // Type: LISTING_SALE, OFFER_ACCEPTED, AUCTION_WON
  tradeType            String   @map("trade_type")

  sellerAddress        String   @map("seller_address")
  buyerAddress         String   @map("buyer_address")
  priceCents           Int      @map("price_cents")

  // Royalty splits (20% to creator, 80% to seller, 0% platform)
  creatorRoyaltyCents  Int      @map("creator_royalty_cents")
  sellerProceedsCents  Int      @map("seller_proceeds_cents")

  transactionHash      String?  @map("transaction_hash")
  createdAt            DateTime @default(now()) @map("created_at")

  // Relations
  nft                  NFT      @relation(fields: [tokenId], references: [tokenId])

  @@index([tokenId])
  @@index([sellerAddress])
  @@index([buyerAddress])
  @@index([createdAt])
  @@map("trades")
}

// Marketplace Settings
model MarketplaceSettings {
  id                      String   @id @default("main")
  tradingEnabled          Boolean  @default(false) @map("trading_enabled")
  listingsEnabled         Boolean  @default(false) @map("listings_enabled")
  offersEnabled           Boolean  @default(false) @map("offers_enabled")
  auctionsEnabled         Boolean  @default(true) @map("auctions_enabled")
  creatorRoyaltyPercent   Int      @default(20) @map("creator_royalty_percent")
  platformFeePercent      Int      @default(0) @map("platform_fee_percent")
  minListingPriceCents    Int      @default(100) @map("min_listing_price_cents")
  maxOfferExpireDays      Int      @default(30) @map("max_offer_expire_days")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("marketplace_settings")
}

// Price Alerts (User watchlist)
model PriceAlert {
  id               String    @id @default(uuid())
  userAddress      String    @map("user_address")
  userEmail        String    @map("user_email")
  tokenId          Int       @map("token_id")
  targetPriceCents Int       @map("target_price_cents")

  // Type: BELOW, ABOVE
  alertType        String    @map("alert_type")

  triggered        Boolean   @default(false)
  createdAt        DateTime  @default(now()) @map("created_at")
  triggeredAt      DateTime? @map("triggered_at")

  @@index([userAddress])
  @@index([tokenId])
  @@index([triggered])
  @@map("price_alerts")
}

// Banned Addresses
model BannedAddress {
  id            String   @id @default(uuid())
  walletAddress String   @unique @map("wallet_address")
  reason        String?
  bannedBy      String   @map("banned_by")
  bannedAt      DateTime @default(now()) @map("banned_at")

  @@map("banned_addresses")
}

// Whitelisted Addresses
model WhitelistAddress {
  id            String   @id @default(uuid())
  walletAddress String   @unique @map("wallet_address")
  note          String?
  addedBy       String   @map("added_by")
  addedAt       DateTime @default(now()) @map("added_at")

  @@map("whitelist_addresses")
}

// Admin Audit Log
model AdminAuditLog {
  id          String   @id @default(uuid())
  adminId     String   @map("admin_id")
  adminEmail  String?  @map("admin_email")
  action      String   // LOGIN, LOGOUT, SETTING_CHANGE, PHASE_ADVANCE, BAN_USER, etc.
  details     String?  // JSON details
  ipAddress   String?  @map("ip_address")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

// Email Broadcast History
model EmailBroadcast {
  id            String   @id @default(uuid())
  subject       String
  body          String
  recipientType String   @map("recipient_type") // ALL, BUYERS, AUCTION_PARTICIPANTS
  sentBy        String   @map("sent_by")
  sentCount     Int      @default(0) @map("sent_count")
  sentAt        DateTime @default(now()) @map("sent_at")

  @@map("email_broadcasts")
}

// User Notification Preferences
model NotificationPreference {
  id              String   @id @default(uuid())
  userAddress     String   @unique @map("user_address")
  userEmail       String   @map("user_email")
  offersEnabled   Boolean  @default(true) @map("offers_enabled")
  auctionsEnabled Boolean  @default(true) @map("auctions_enabled")
  salesEnabled    Boolean  @default(true) @map("sales_enabled")
  priceAlerts     Boolean  @default(true) @map("price_alerts")
  marketing       Boolean  @default(false)
  quietHoursStart Int?     @map("quiet_hours_start") // Hour 0-23
  quietHoursEnd   Int?     @map("quiet_hours_end")
  unsubscribedAt  DateTime? @map("unsubscribed_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("notification_preferences")
}

// ============================================
// BENEFACTOR TRACKING MODELS
// ============================================

// Benefactor Settings (Configuration)
model BenefactorSettings {
  id                    String   @id @default("main")
  benefactorName        String   @default("Space Exploration Initiatives") @map("benefactor_name")
  benefactorWallet      String?  @map("benefactor_wallet") // ETH wallet for crypto payments
  creatorWallet         String?  @map("creator_wallet") // Your ETH wallet
  benefactorSharePercent Int     @default(30) @map("benefactor_share_percent")
  creatorSharePercent   Int      @default(70) @map("creator_share_percent")
  adminEmail            String?  @map("admin_email") // For payment reminders
  enableReminders       Boolean  @default(true) @map("enable_reminders")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("benefactor_settings")
}

// Benefactor Manual Payments (Primary Sales + USD Auctions)
model BenefactorPayment {
  id                    String    @id @default(uuid())
  month                 Int       // 1-12
  year                  Int

  // Breakdown amounts (in cents)
  primarySalesCents     Int       @map("primary_sales_cents")
  auctionSalesCents     Int       @map("auction_sales_cents") // USD auctions only
  totalOwedCents        Int       @map("total_owed_cents") // 30% of above

  // Revenue totals for reference
  primaryRevenueCents   Int       @map("primary_revenue_cents") // Total primary revenue
  auctionRevenueCents   Int       @map("auction_revenue_cents") // Total USD auction revenue

  // Payment details
  paymentMethodId       String?   @map("payment_method_id")
  paymentMethodName     String?   @map("payment_method_name")
  referenceNumber       String?   @map("reference_number")
  notes                 String?

  // Status: UNPAID, PAID, LATE
  status                String    @default("UNPAID")

  // Dates
  dueDate               DateTime  @map("due_date")
  paidAt                DateTime? @map("paid_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([month, year])
  @@index([status])
  @@index([year])
  @@map("benefactor_payments")
}

// Saved Payment Methods
model BenefactorPaymentMethod {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  isDefault   Boolean   @default(false) @map("is_default")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("benefactor_payment_methods")
}

// Smart Contract Payments (Crypto Auctions + Creator Royalties - Auto-paid)
model SmartContractPayment {
  id                  String    @id @default(uuid())

  // Transaction type: AUCTION_SALE, CREATOR_ROYALTY
  transactionType     String    @map("transaction_type")

  // Amounts
  ethAmount           Float     @map("eth_amount")
  usdValueAtTime      Float     @map("usd_value_at_time") // USD value at transaction time
  ethPriceAtTime      Float     @map("eth_price_at_time") // ETH price used for conversion

  // Related data
  tokenId             Int?      @map("token_id")
  nftName             String?   @map("nft_name")
  auctionId           String?   @map("auction_id")
  tradeId             String?   @map("trade_id")

  // Wallet addresses
  fromWallet          String    @map("from_wallet")
  toWallet            String    @map("to_wallet") // Benefactor wallet

  // Blockchain data
  transactionHash     String    @unique @map("transaction_hash")
  blockNumber         Int?      @map("block_number")

  // Status: PENDING, CONFIRMED, FAILED
  status              String    @default("CONFIRMED")

  createdAt           DateTime  @default(now()) @map("created_at")

  @@index([transactionType])
  @@index([toWallet])
  @@index([createdAt])
  @@map("smart_contract_payments")
}

// ETH Price History (For accurate reporting)
model EthPriceHistory {
  id          String    @id @default(uuid())
  priceUsd    Float     @map("price_usd")
  timestamp   DateTime  @default(now())
  source      String    @default("coingecko") // API source

  @@index([timestamp])
  @@map("eth_price_history")
}

// Benefactor Payment Reminders (Track reminder status)
model BenefactorReminder {
  id              String    @id @default(uuid())
  month           Int
  year            Int
  reminderType    String    @map("reminder_type") // DUE_TODAY, OVERDUE_5, OVERDUE_10, DAILY
  daysSent        Int       @default(0) @map("days_sent") // For tracking which day reminders were sent
  sentAt          DateTime  @default(now()) @map("sent_at")
  acknowledged    Boolean   @default(false)
  acknowledgedAt  DateTime? @map("acknowledged_at")

  @@index([month, year])
  @@map("benefactor_reminders")
}
