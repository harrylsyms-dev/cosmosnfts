name: Generate NFT Images

# NOTE: Scheduled execution disabled - now using Vercel Cron Jobs
# See frontend/vercel.json for cron configuration
# This workflow can still be triggered manually via workflow_dispatch

on:
  # schedule:
  #   # Run every day at 2 AM UTC
  #   - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      phase:
        description: 'Phase number to generate (1-81)'
        required: false
        default: ''
      force:
        description: 'Force regenerate existing images'
        required: false
        default: 'false'

jobs:
  generate-images:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 hours max

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npx prisma generate

      - name: Run image generation
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          LEONARDO_AI_API_KEY: ${{ secrets.LEONARDO_AI_API_KEY }}
          PINATA_API_KEY: ${{ secrets.PINATA_API_KEY }}
          PINATA_API_SECRET: ${{ secrets.PINATA_API_SECRET }}
          OWNER_WALLET_ADDRESS: ${{ secrets.OWNER_WALLET_ADDRESS }}
          PHASE_NUMBER: ${{ github.event.inputs.phase }}
          FORCE_REGENERATE: ${{ github.event.inputs.force }}
        run: npx ts-node scripts/generateImages.ts

      - name: Notify on success
        if: success()
        run: echo "Image generation completed successfully"

      - name: Notify on failure
        if: failure()
        run: echo "Image generation failed - check logs"

  finalize-auctions:
    runs-on: ubuntu-latest
    needs: generate-images
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npx prisma generate

      - name: Finalize ended auctions
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          POLYGON_RPC_URL: ${{ secrets.POLYGON_RPC_URL }}
          OWNER_WALLET_PRIVATE_KEY: ${{ secrets.OWNER_WALLET_PRIVATE_KEY }}
          CONTRACT_ADDRESS: ${{ secrets.CONTRACT_ADDRESS }}
        run: npx ts-node scripts/finalizeAuctions.ts
